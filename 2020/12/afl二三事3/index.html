<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>AFL二三事 -- 2 - V4ler1an-有毒</title><meta name="Description" content="AFL二三事系列 note 2"><meta property="og:title" content="AFL二三事 -- 2" />
<meta property="og:description" content="AFL二三事系列 note 2" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" /><meta property="og:image" content="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/fuzz.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-04T21:57:40+08:00" />
<meta property="article:modified_time" content="2021-01-05T16:45:40+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/fuzz.png"/>
<meta name="twitter:title" content="AFL二三事 -- 2"/>
<meta name="twitter:description" content="AFL二三事系列 note 2"/>
<meta name="application-name" content="V4ler1an">
<meta name="apple-mobile-web-app-title" content="V4ler1an"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" /><link rel="prev" href="https://www.v4ler1an.com/WindowsDev/WindowsKernel/" /><link rel="next" href="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B2/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "AFL二三事 -- 2",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.v4ler1an.com\/2020\/12\/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/www.v4ler1an.com\/2020\/12\/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3\/fuzz.png",
                            "width":  512 ,
                            "height":  130 
                        }],"genre": "posts","keywords": "Fuzz, AFL","wordcount":  9141 ,
        "url": "https:\/\/www.v4ler1an.com\/2020\/12\/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3\/","datePublished": "2020-12-04T21:57:40+08:00","dateModified": "2021-01-05T16:45:40+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/www.v4ler1an.com\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "有毒"
            },"description": "AFL二三事系列 note 2"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="V4ler1an-有毒"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/personal_logo.png"
        data-srcset="/images/personal_logo.png, /images/personal_logo.png 1.5x, /images/personal_logo.png 2x"
        data-sizes="auto"
        alt="/images/personal_logo.png"
        title="/images/personal_logo.png" /><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>V4ler1an-有毒</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 我 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" selected>简体中文</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="V4ler1an-有毒"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/personal_logo.png"
        data-srcset="/images/personal_logo.png, /images/personal_logo.png 1.5x, /images/personal_logo.png 2x"
        data-sizes="auto"
        alt="/images/personal_logo.png"
        title="/images/personal_logo.png" /><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>V4ler1an-有毒</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">我</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" selected>简体中文</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">AFL二三事 -- 2</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://www.v4ler1an.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>有毒</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/fuzz/"><i class="far fa-folder fa-fw"></i>Fuzz</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-12-04">2020-12-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 9141 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 19 分钟&nbsp;<span id="/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" class="leancloud_visitors" data-flag-title="AFL二三事 -- 2">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/fuzz.png"
        data-srcset="/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/fuzz.png, /2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/fuzz.png 1.5x, /2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/fuzz.png 2x"
        data-sizes="auto"
        alt="/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/fuzz.png"
        title="AFL二三事系列 note 2" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一代码覆盖率">一、代码覆盖率</a>
      <ul>
        <li><a href="#1-计算方法">1. 计算方法</a></li>
        <li><a href="#2-afl中两种代码覆盖率计算方式">2. AFL中两种代码覆盖率计算方式</a></li>
      </ul>
    </li>
    <li><a href="#二插桩">二、插桩</a>
      <ul>
        <li><a href="#1-有源码">1. 有源码</a></li>
        <li><a href="#2-无源码">2. 无源码</a></li>
      </ul>
    </li>
    <li><a href="#三变异策略">三、变异策略</a>
      <ul>
        <li><a href="#效果分析">效果分析</a></li>
        <li><a href="#参考链接">参考链接</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>本文是AFL系列第二篇，主要介绍AFL的一些基本原理。</p>
<h2 id="一代码覆盖率">一、代码覆盖率</h2>
<h3 id="1-计算方法">1. 计算方法</h3>
<p>代码覆盖率的计量单位，通常有3种：</p>
<blockquote>
<p>函数（Fuction-Level）</p>
<p>基本块（BasicBlock-Level）</p>
<p>边界（Edge-Level）</p>
</blockquote>
<ul>
<li>
<p>（1）函数（Fuction-Level）</p>
<p>这个很容易理解，就是代码执行时调用到哪些函数，但是函数里面的具体代码行却不作统计，相对比较粗糙但高效的统计方式。</p>
<p>所以，通常的统计方式是用基本块，简称BB。</p>
</li>
<li>
<p>（2）基本块（BasicBlock-Level）</p>
<p>基本块，直接看下图就很容易理解了。</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105527.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105527.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105527.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105527.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105527.png"
        title="image-20210819105527622" /></p>
<p>IDA中每一块代码就代表着一个基本块，就是以指令跳转为作划分界限的。</p>
<ul>
<li>
<p>（3）边界（Edge-Level）</p>
<p>edge本身就涵盖了基本块部分，唯一的差别是edge多记录了一些执行边界的信息。比如示例代码：</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094512.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094512.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094512.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094512.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094512.png"
        title="image-20210825094512035" /></p>
<p>在IDA中可以看到A、B、C这3个基本块，但当a为假时，程序就会从A执行到C。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094442.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094442.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094442.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094442.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094442.png"
        title="image-20210825094442736" /></p>
<p>前面基本块的方式就无法确切地知道是否曾从A执行到C，尤其是该段代码被多次执行的情况，就更无法知道，这时edge覆盖方式就出现了。</p>
<p>edge会在A跟C之间建立虚拟块D，通过判断D是否执行过，来确认是否曾从A执行到C，这种方式也会比较消耗性能。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094456.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094456.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094456.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094456.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094456.png"
        title="image-20210825094456219" /></p>
<p><em>以上内容摘自泉哥博客，原文链接<code>https://riusksk.me/2018/07/29/honggfuzz%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E6%8A%80%E6%9C%AF1/</code></em></p>
<p>AFL采用的是第三种方式。</p>
<h3 id="2-afl中两种代码覆盖率计算方式">2. AFL中两种代码覆盖率计算方式</h3>
<p>AFL支持两种代码覆盖率计算方式，有源码的情况下，在源代码编译时进行插桩，无源码的情况下，使用QEMU进行二进制插桩。下一章节会分别详细讲解这两种情况使用的插桩技术。</p>
<h2 id="二插桩">二、插桩</h2>
<h3 id="1-有源码">1. 有源码</h3>
<p>我们以如下代码为例进行说明，文件名为 <code>socket.c</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define SERV_PORT 8000
</span><span class="cp">#define SIZE 100
</span><span class="cp">#define MAXLINE 64
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">command</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">recv</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">recv</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">recv</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">servaddr</span><span class="p">,</span><span class="n">cliaddr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">cliaddr_len</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span><span class="n">connfd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
    <span class="n">listenfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">SERV_PORT</span><span class="p">);</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="n">listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Accepting connections..</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    
    <span class="n">cliaddr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
    <span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cliaddr_len</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">send_msg</span><span class="p">[</span><span class="n">MAXLINE</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;hello, send by send() :</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
    <span class="n">send</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">send_msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">send_msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">MAXLINE</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;test &#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">send_msg</span><span class="p">,</span> <span class="s">&#34;test: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;help&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">send_msg</span><span class="p">,</span> <span class="s">&#34;help:</span><span class="se">\n\t</span><span class="s">test</span><span class="se">\n\t</span><span class="s">command</span><span class="se">\n\t</span><span class="s">exit</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;command &#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)){</span>
            <span class="n">command</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">send_msg</span><span class="p">,</span> <span class="s">&#34;it&#39;s a command</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;exit&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">send</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="s">&#34;bye~</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">send_msg</span><span class="p">,</span> <span class="s">&#34;unknown command!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">send</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">send_msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">send_msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Client say close the connection..</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以进行源码插桩的指令有 <code>afl-gcc</code>、<code>afl-g++</code>、<code>afl-clang</code>、<code>afl-clang++</code> ( <code>afl-clang-fast</code> 和 <code>afl-clang-fast++</code> 暂不讨论)，通过查看这些文件的具体属性，可以发现后三者都是 <code>afl-gcc</code> 的软链接，其实都是同一个二进制文件：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105959.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105959.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105959.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105959.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819105959.png"
        title="image-20210819105959293" /></p>
<p>通过分析 <code>afl-gcc.c</code> 中的代码可以发现， <code>afl-gcc</code> 就是在原有的编译指令上增加一些编译选项然后调用对应的系统调用指令：</p>
<p>为了方便查看每次源码编译时的编译选项，可以对 <code>afl-gcc.c</code> 进行修改，在 <code>main()</code> 函数中调用 <code>execvp()</code> 之前添加如下代码，打印出实际执行的编译指令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">//print command
</span><span class="c1"></span><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cc_par_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s &#34;</span><span class="p">,</span> <span class="n">cc_params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>其中数组 <code>cc_params</code> 存放着编译指令和选项，整数 <code>cc_par_cnt</code> 存放数组有效值，修改完成后对AFL重新进行编译即可。</p>
<p>（<code>afl-clang-fast</code> 和 <code>afl-clang-fast++</code> 对应的源码文件为 <code>llvm_mode/afl-clang-fast.c</code> ，修改方法相同）</p>
<p>使用 <code>afl-gcc</code> 对上面代码进行编译</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">afl-gcc -o socket_afl socket.c
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819163111.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819163111.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819163111.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819163111.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819163111.png"
        title="image-20210819163111374" /></p>
<p>可以看到实际执行的编译指令为 <code>gcc -o socket socket.c -B /usr/local/lib/afl -g -O3 -funroll-loops -D__AFL_COMPILER=1 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</code> ，其中 <code>-B &lt;directory&gt;</code> 选项用于将<directory>添加到编译器的搜索路径，<code>-g</code> 选项生成调试信息，<code>-O3</code> 优化生成代码，<code>-funroll-loops</code> 选项展开循环的迭代次数可以在编译时或进入循环时确定，剩余两个为AFL使用的选项。（gcc的选项可以参考此链接 <code>https://gcc.gnu.org/onlinedocs/gcc-4.4.2/gcc/Optimize-Options.html</code>）</p>
<p>如果了解编译过程，那么就知道把源代码编译成二进制，主要是经过”源代码”-&gt;”汇编代码”-&gt;”二进制”这样的过程。而将汇编代码编译成为二进制的工具，即为汇编器assembler。Linux系统下的常用汇编器是as。不过，编译完成AFL后，在其目录下也会存在一个as文件，并作为符号链接指向afl-as。所以，如果通过-B选项为gcc设置了搜索路径，那么afl-as便会作为汇编器，执行实际的汇编操作。</p>
<p>所以，AFL的代码插桩，就是在将源文件编译为汇编代码后，通过 <code>afl-as</code> 完成。</p>
<p><strong>afl-as</strong></p>
<p>下面通过对比 <code>gcc</code> 和 <code>afl-gcc</code> 的编译结果进行大致分析。</p>
<p>将 <code>afl-gcc</code> 中添加的 <code>-B</code>、<code>-D__AFL_COMPILER=1</code>、<code>DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</code> 三个选项去掉，调用 <code>gcc</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">gcc -o socket socket.c -g -O3 -funroll-loops
</code></pre></td></tr></table>
</div>
</div><p>这样就生成了 <code>socket_afl</code> 和 <code>socket</code> 两个文件。</p>
<p>使用 <code>bindiff</code> 对这两个文件中的 <code>main</code> 函数进行对比</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164111.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164111.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164111.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164111.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164111.png"
        title="image-20210819164111883" /></p>
<p>上图中右下角部分看起来结构不一样，不过这里是 <code>bindiff</code> 识别bug，多出了一个代码块并且少了一条线，我们可以分别使用 <code>ida</code> 打开这两个文件，查看 <code>main</code> 函数的结构图</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164420.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164420.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164420.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164420.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164420.png"
        title="image-20210819164420030" /></p>
<p>这里对 <code>bindiff</code> 误报结果的详细分析就不多说了，这个不是本次的重点。</p>
<p>可以看到 <code>afl</code> 进行源代码插桩时不会改变代码的逻辑结构，也不会增加或减少代码块。</p>
<p>对比看下每个代码块中代码的区别</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164616.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164616.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164616.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164616.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819164616.png"
        title="image-20210819164616722" /></p>
<p>可以看出，基本每个代码块都被添加了一段相似的汇编代码</p>
<p>在 <code>ida</code> 中将这部分代码拷贝出来，如下：</p>
<pre><code>lea     rsp, [rsp-98h]
mov     [rsp+1D0h+var_1D0], rdx
mov     [rsp+1D0h+var_1C8], rcx
mov     [rsp+1D0h+var_1C0], n
mov     rcx, 650Eh
call    __afl_maybe_log
mov     n, [rsp+1D0h+var_1C0]
mov     rcx, [rsp+1D0h+var_1C8]
mov     rdx, [rsp+1D0h+var_1D0]
lea     rsp, [rsp+98h]
</code></pre>
<p>对比可以发现，不同的代码块只有 <code>mov     rcx, 650Eh</code> 这条汇编代码向 <code>rcx</code> 存放的值不同，这个就是随机生成的标识代码块的id，当运行到这部分汇编时 <code>afl</code> 就知道是哪个代码块被执行了。</p>
<p>上述 <code>ida</code> 中的汇编代码原型可以在 <code>afl-as.h</code> 中找到（以64位代码为例）：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819165131.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819165131.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819165131.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819165131.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819165131.png"
        title="image-20210819165131286" /></p>
<p>上述代码执行的主要功能包括：</p>
<ul>
<li>保存 <code>rdx</code>、 <code>rcx</code> 、<code>rax</code> 寄存器</li>
<li>将 <code>rcx</code> 的值设置为 <code>fprintf()</code> 函数将要打印的变量内容</li>
<li>调用 <code>__afl_maybe_log</code> 函数</li>
<li>恢复寄存器</li>
</ul>
<p>在以上的功能中， <code>__afl_maybe_log</code> 是插桩代码所执行的实际内容，后续将详细展开。</p>
<p>可以在 <code>afl-as.c</code> 中查看到该汇编的调用，通过 <code>fprintf()</code> 函数的调用，将格式化字符串添加到汇编文件的相应位置。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094725.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094725.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094725.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094725.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094725.png"
        title="image-20210819170330292" /></p>
<p>这里分析下 <code>R(MAP_SIZE)</code> ，它就是上面汇编代码中将 <code>rcx</code> 设置的值。根据定义， <code>MAP_SIZE</code> 为64K，而对于 <code>R(x)</code> 函数定义如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819170411.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819170411.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819170411.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819170411.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210819170411.png"
        title="image-20210819170411739" /></p>
<p>其中 <code>R(MAP_SIZE)</code> 相当于 <code>random() % (1 &lt;&lt; MAP_SIZE_POW2)</code> ，也就是生成随机数，所以标识代码块的id是随机生成的（两次编译生成的代码段id不同）。</p>
<p>上述过程总结起来就是<strong>在处理到某个分支需要插入桩代码时， <code>afl-as</code> 会随机生成一个随机数，作为运行时保存在 <code>rcx</code> 中的值。而这个随机数，便是用于标识这个代码块的id。</strong></p>
<p>（<strong>备注：因为代码块ID随机的问题，会导致一定的性能问题。在AFL++中开发了一种新的afl-clang-lto编译模式，对该问题进行了一定程度上的优化，后续在分析AFL++时会再深入谈该问题</strong>）</p>
<h3 id="2-无源码">2. 无源码</h3>
<p>无源码情况下，AFL使用QEMU进行二进制插桩，具体插桩原理待补充。</p>
<h2 id="三变异策略">三、变异策略</h2>
<p>AFL维护了一个队列(queue)，每次从这个队列中取出一个文件，对其进行大量变异，并检查运行后是否会引起目标崩溃、发现新路径等结果。变异的主要类型如下：</p>
<blockquote>
<p>bitflip，按位翻转，1变为0，0变为1<br>
arithmetic，整数加/减算术运算<br>
interest，把一些特殊内容替换到原文件中<br>
dictionary，把自动生成或用户提供的token替换/插入到原文件中<br>
havoc，中文意思是“大破坏”，此阶段会对原文件进行大量变异<br>
splice，中文意思是“拼接”，此阶段会将两个文件拼接起来得到一个新的文件</p>
</blockquote>
<p>其中，前四项 bitflip, arithmetic, interest, dictionary 是非 dumb mode（-d）和主 fuzzer（-M）会进行的操作，由于其变异方式没有随机性，所以也称为 deterministic fuzzing ；havoc 和 splice 则存在随机性，是所有状况的 fuzzer（是否 dumb mode、主从 fuzzer）都会执行的变异。</p>
<p>以下将对这些变异类型进行具体介绍。</p>
<p>###（1） bitflip</p>
<p>拿到一个原始文件，首先进行的就是bitflip，而且还会根据翻转量/步长进行多种不同的翻转，按照顺序依次为：</p>
<blockquote>
<p>bitflip 1/1， 每次翻转1个bit，按照每1个bit的步长从头开始<br>
bitflip 2/1， 每次翻转相邻的2个bit，按照每1个bit的步长从头开始<br>
bitflip 4/1， 每次翻转相邻的4个bit，按照每1个bit的步长从头开始<br>
bitflip 8/8， 每次翻转相邻的8个bit，按照每8个bit的步长从头开始，即依次对每个byte做翻转<br>
bitflip 16/8，每次翻转相邻的16个bit，按照每8个bit的步长从头开始，即依次对每个word做翻转<br>
bitflip 32/8，每次翻转相邻的32个bit，按照每8个bit的步长从头开始，即依次对每个dword做翻转<br></p>
</blockquote>
<p>在上述过程中，AFL巧妙地嵌入了一些对文件格式的启发式判断，以图尽可能多得获取文件信息。</p>
<p><strong>自动检测token</strong></p>
<p>在进行 bitflip 1/1变异时，对于每个 byte 的最低位( least significant bit )翻转还进行了额外的处理：如果连续多个 bytes 的最低位被翻转后，程序的执行路径都未变化，而且与原始执行路径不一致，那么就把这一段连续的 bytes 判断是一条token。</p>
<p>例如，PNG文件中用IHDR作为起始块的标识，那么就会存在类似于以下的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">	........IHDR........
</code></pre></td></tr></table>
</div>
</div><p>当翻转到字符I的最高位时，因为IHDR被破坏，此时程序的执行路径肯定与处理正常文件的路径是不同的；随后，在翻转接下来3个字符的最高位时，IHDR标识同样被破坏，程序应该会采取同样的执行路径。由此，AFL就判断得到一个可能的token：IHDR，并将其记录下来为后面的变异提供备选。</p>
<p>AFL采取的这种方式是非常巧妙的：就本质而言，这实际上是对每个byte进行修改并检查执行路径；但集成到bitflip后，就不需要再浪费额外的执行资源了。此外，为了控制这样自动生成的token的大小和数量，AFL还在config.h中通过宏定义了限制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">	<span class="cm">/* Length limits for auto-detected dictionary tokens: */</span>
	
	<span class="cp">#define MIN_AUTO_EXTRA 3 #define MAX_AUTO_EXTRA 32 
</span><span class="cp"></span>	<span class="cm">/* Maximum number of auto-extracted dictionary tokens to actually use in fuzzing (first value), and to keep in memory as candidates. The latter should be much higher than the former. */</span>
	
	<span class="cp">#define USE_AUTO_EXTRAS 10 
</span><span class="cp"></span>	<span class="cp">#define MAX_AUTO_EXTRAS (USE_AUTO_EXTRAS * 10)
</span></code></pre></td></tr></table>
</div>
</div><p>对于一些文件来说，我们已知其格式中出现的token长度不会超过4，那么我们就可以修改 <code>MAX_AUTO_EXTRA</code> 为4并重新编译AFL，以排除一些明显不会是token的情况。遗憾的是，这些设置是通过宏定义来实现，所以不能做到运行时指定，每次修改后必须重新编译AFL。</p>
<p><strong>生成effector map</strong></p>
<p>在进行bitflip 8/8变异时，AFL还生成了一个非常重要的信息：effector map。这个effector map几乎贯穿了整个deterministic fuzzing的始终。</p>
<p>具体地，在对每个byte进行翻转时，如果其造成执行路径与原始路径不一致，就将该byte在effector map中标记为1，即“有效”的，否则标记为0，即“无效”的。</p>
<p>这样做的逻辑是：如果一个byte完全翻转，都无法带来执行路径的变化，那么这个byte很有可能是属于”data”，而非”metadata”（例如size, flag等），对整个fuzzing的意义不大。所以，在随后的一些变异中，会参考effector map，跳过那些“无效”的byte，从而节省了执行资源。</p>
<p>由此，通过极小的开销（没有增加额外的执行次数），AFL又一次对文件格式进行了启发式的判断。看到这里，不得不叹服于AFL实现上的精妙。</p>
<p>不过，在某些情况下并不会检测有效字符。第一种情况就是dumb mode或者从fuzzer，此时文件所有的字符都有可能被变异。第二、第三种情况与文件本身有关：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">	<span class="cm">/* Minimum input file length at which the effector logic kicks in: */</span>
	
	<span class="cp">#define EFF_MIN_LEN 128 
</span><span class="cp"></span>	<span class="cm">/* Maximum effector density past which everything is just fuzzed unconditionally (%): */</span>
	
	<span class="cp">#define EFF_MAX_PERC 90
</span></code></pre></td></tr></table>
</div>
</div><p>即默认情况下，如果文件小于128 bytes，那么所有字符都是“有效”的；同样地，如果AFL发现一个文件有超过90%的bytes都是“有效”的，那么也不差那10%了，大笔一挥，干脆把所有字符都划归为“有效”。</p>
<hr>
<p>###（2） arithmetic</p>
<p>在bitflip变异全部进行完成后，便进入下一个阶段：arithmetic。与bitflip类似的是，arithmetic根据目标大小的不同，也分为了多个子阶段：</p>
<blockquote>
<p>arith 8/8，每次对8个bit进行加减运算，按照每8个bit的步长从头开始，即对文件的每个byte进行整数加减变异<br>
arith 16/8，每次对16个bit进行加减运算，按照每8个bit的步长从头开始，即对文件的每个word进行整数加减变异<br>
arith 32/8，每次对32个bit进行加减运算，按照每8个bit的步长从头开始，即对文件的每个dword进行整数加减变异<br></p>
</blockquote>
<p>加减变异的上限，在config.h中的宏ARITH_MAX定义，默认为35。所以，对目标整数会进行+1, +2, …, +35, -1, -2, …, -35的变异。特别地，由于整数存在大端序和小端序两种表示方式，AFL会贴心地对这两种整数表示方式都进行变异。</p>
<p>此外，AFL还会智能地跳过某些arithmetic变异。第一种情况就是前面提到的effector map：如果一个整数的所有bytes都被判断为“无效”，那么就跳过对整数的变异。第二种情况是之前bitflip已经生成过的变异：如果加/减某个数后，其效果与之前的某种bitflip相同，那么这次变异肯定在上一个阶段已经执行过了，此次便不会再执行。</p>
<hr>
<p>###（3） interest</p>
<p>下一个阶段是interest，具体可分为：</p>
<blockquote>
<p>interest 8/8，每次对8个bit进替换，按照每8个bit的步长从头开始，即对文件的每个byte进行替换<br>
interest 16/8，每次对16个bit进替换，按照每8个bit的步长从头开始，即对文件的每个word进行替换<br>
interest 32/8，每次对32个bit进替换，按照每8个bit的步长从头开始，即对文件的每个dword进行替换<br></p>
</blockquote>
<p>而用于替换的”interesting values”，是AFL预设的一些比较特殊的数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">s8</span>  <span class="n">interesting_8</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="n">INTERESTING_8</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">s16</span> <span class="n">interesting_16</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">INTERESTING_8</span><span class="p">,</span> <span class="n">INTERESTING_16</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">interesting_32</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">INTERESTING_8</span><span class="p">,</span> <span class="n">INTERESTING_16</span><span class="p">,</span> <span class="n">INTERESTING_32</span> <span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>这些数的定义在config.h文件中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">	<span class="cm">/* List of interesting values to use in fuzzing. */</span>
	
	<span class="cp">#define INTERESTING_8 \ -128, </span><span class="cm">/* Overflow signed 8-bit when decremented */</span><span class="cp"> \ -1, </span><span class="cm">/* */</span><span class="cp"> \ 0, </span><span class="cm">/* */</span><span class="cp"> \ 1, </span><span class="cm">/* */</span><span class="cp"> \ 16, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 32, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 64, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 100, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 127 </span><span class="cm">/* Overflow signed 8-bit when incremented */</span><span class="cp"> 
</span><span class="cp"></span>	<span class="cp">#define INTERESTING_16 \ -32768, </span><span class="cm">/* Overflow signed 16-bit when decremented */</span><span class="cp"> \ -129, </span><span class="cm">/* Overflow signed 8-bit */</span><span class="cp"> \ 128, </span><span class="cm">/* Overflow signed 8-bit */</span><span class="cp"> \ 255, </span><span class="cm">/* Overflow unsig 8-bit when incremented */</span><span class="cp"> \ 256, </span><span class="cm">/* Overflow unsig 8-bit */</span><span class="cp"> \ 512, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 1000, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 1024, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 4096, </span><span class="cm">/* One-off with common buffer size */</span><span class="cp"> \ 32767 </span><span class="cm">/* Overflow signed 16-bit when incremented */</span><span class="cp"> 
</span><span class="cp"></span>	<span class="cp">#define INTERESTING_32 \ -2147483648LL, </span><span class="cm">/* Overflow signed 32-bit when decremented */</span><span class="cp"> \ -100663046, </span><span class="cm">/* Large negative number (endian-agnostic) */</span><span class="cp"> \ -32769, </span><span class="cm">/* Overflow signed 16-bit */</span><span class="cp"> \ 32768, </span><span class="cm">/* Overflow signed 16-bit */</span><span class="cp"> \ 65535, </span><span class="cm">/* Overflow unsig 16-bit when incremented */</span><span class="cp"> \ 65536, </span><span class="cm">/* Overflow unsig 16 bit */</span><span class="cp"> \ 100663045, </span><span class="cm">/* Large positive number (endian-agnostic) */</span><span class="cp"> \ 2147483647 </span><span class="cm">/* Overflow signed 32-bit when incremented */</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p>可以看到，用于替换的基本都是可能会造成溢出的数。</p>
<p>与之前类似，effector map仍然会用于判断是否需要变异；此外，如果某个interesting value，是可以通过bitflip或者arithmetic变异达到，那么这样的重复性变异也是会跳过的。</p>
<hr>
<p>###（4） dictionary</p>
<p>进入到这个阶段，就接近deterministic fuzzing的尾声了。具体有以下子阶段：</p>
<blockquote>
<p>user extras (over)，从头开始，将用户提供的tokens依次替换到原文件中<br>
user extras (insert)，从头开始，将用户提供的tokens依次插入到原文件中<br>
auto extras (over)，从头开始，将自动检测的tokens依次替换到原文件中<br></p>
</blockquote>
<p>其中，用户提供的tokens，是在词典文件中设置并通过-x选项指定的，如果没有则跳过相应的子阶段。</p>
<p><strong>user extras (over)</strong></p>
<p>对于用户提供的tokens，AFL先按照长度从小到大进行排序。这样做的好处是，只要按照顺序使用排序后的tokens，那么后面的token不会比之前的短，从而每次覆盖替换后不需要再恢复到原状。</p>
<p>随后，AFL会检查tokens的数量，如果数量大于预设的MAX_DET_EXTRAS（默认值为200），那么对每个token会根据概率来决定是否进行替换：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">extras_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* Skip extras probabilistically if extras_cnt &gt; MAX_DET_EXTRAS. Also skip them if there&#39;s no room to insert the payload, if the token is redundant, or if its entire span has no bytes set in the effector map. */</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">extras_cnt</span> <span class="o">&gt;</span> <span class="n">MAX_DET_EXTRAS</span> <span class="o">&amp;&amp;</span> <span class="n">UR</span><span class="p">(</span><span class="n">extras_cnt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_DET_EXTRAS</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">extras</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span> <span class="o">||</span>
        <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">out_buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">extras</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span>
        <span class="o">!</span><span class="n">memchr</span><span class="p">(</span><span class="n">eff_map</span> <span class="o">+</span> <span class="n">EFF_APOS</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EFF_SPAN_ALEN</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">extras</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">len</span><span class="p">)))</span> <span class="p">{</span>

    <span class="n">stage_max</span><span class="o">--</span><span class="p">;</span>
    <span class="k">continue</span><span class="p">;</span>

    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的UR(extras_cnt)是运行时生成的一个0到extras_cnt之间的随机数。所以，如果用户词典中一共有400个tokens，那么每个token就有200/400=50%的概率执行替换变异。我们可以修改MAX_DET_EXTRAS的大小来调整这一概率。</p>
<p>由上述代码也可以看到，effector map在这里同样被使用了：如果要替换的目标bytes全部是“无效”的，那么就跳过这一段，对下一段目标执行替换。</p>
<p><strong>user extras (insert)</strong></p>
<p>这一子阶段是对用户提供的tokens执行插入变异。不过与上一个子阶段不同的是，此时并没有对tokens数量的限制，所以全部tokens都会从原文件的第1个byte开始，依次向后插入；此外，由于原文件并未发生替换，所以effector map不会被使用。</p>
<p>这一子阶段最特别的地方，就是变异不能简单地恢复。之前每次变异完，在变异位置处简单取逆即可，例如bitflip后，再进行一次同样的bitflip就恢复为原文件。正因为如此，之前的变异总体运算量并不大。</p>
<p>但是，对于插入这种变异方式，恢复起来则复杂的多，所以AFL采取的方式是：将原文件分割为插入前和插入后的部分，再加上插入的内容，将这3部分依次复制到目标缓冲区中（当然这里还有一些小的优化，具体可阅读代码）。而对每个token的每处插入，都需要进行上述过程。所以，如果用户提供了大量tokens，或者原文件很大，那么这一阶段的运算量就会非常的多。直观表现上，就是AFL的执行状态栏中，”user extras (insert)”的总执行量很大，执行时间很长。如果出现了这种情况，那么就可以考虑适当删减一些tokens。</p>
<p><strong>auto extras (over)</strong></p>
<p>这一项与”user extras (over)”很类似，区别在于，这里的tokens是最开始bitflip阶段自动生成的。另外，自动生成的tokens总量会由USE_AUTO_EXTRAS限制（默认为10）。</p>
<hr>
<p>###（5） havoc</p>
<p>对于非dumb mode的主fuzzer来说，完成了上述deterministic fuzzing后，便进入了充满随机性的这一阶段；对于dumb mode或者从fuzzer来说，则是直接从这一阶段开始。</p>
<p>havoc，顾名思义，是充满了各种随机生成的变异，是对原文件的“大破坏”。具体来说，havoc包含了对原文件的多轮变异，每一轮都是将多种方式组合（stacked）而成：</p>
<blockquote>
<p>随机选取某个bit进行翻转<br>
随机选取某个byte，将其设置为随机的interesting value<br>
随机选取某个word，并随机选取大、小端序，将其设置为随机的interesting value<br>
随机选取某个dword，并随机选取大、小端序，将其设置为随机的interesting value<br>
随机选取某个byte，对其减去一个随机数<br>
随机选取某个byte，对其加上一个随机数<br>
随机选取某个word，并随机选取大、小端序，对其减去一个随机数<br>
随机选取某个word，并随机选取大、小端序，对其加上一个随机数<br>
随机选取某个dword，并随机选取大、小端序，对其减去一个随机数<br>
随机选取某个dword，并随机选取大、小端序，对其加上一个随机数<br>
随机选取某个byte，将其设置为随机数<br>
随机删除一段bytes<br>
随机选取一个位置，插入一段随机长度的内容，其中75%的概率是插入原文中随机位置的内容，25%的概率是插入一段随机选取的数<br>
随机选取一个位置，替换为一段随机长度的内容，其中75%的概率是替换成原文中随机位置的内容，25%的概率是替换成一段随机选取的数<br>
随机选取一个位置，用随机选取的token（用户提供的或自动生成的）替换<br>
随机选取一个位置，用随机选取的token（用户提供的或自动生成的）插入<br></p>
</blockquote>
<p>怎么样，看完上面这么多的“随机”，有没有觉得晕？还没完，AFL会生成一个随机数，作为变异组合的数量，并根据这个数量，每次从上面那些方式中随机选取一个（可以参考高中数学的有放回摸球），依次作用到文件上。如此这般丧心病狂的变异，原文件就大概率面目全非了，而这么多的随机性，也就成了fuzzing过程中的不可控因素，即所谓的“看天吃饭”了。</p>
<hr>
<p>###（6） splice</p>
<p>历经了如此多的考验，文件的变异也进入到了最后的阶段：splice。如其意思所说，splice是将两个seed文件拼接得到新的文件，并对这个新文件继续执行havoc变异。</p>
<p>具体地，AFL在seed文件队列中随机选取一个，与当前的seed文件做对比。如果两者差别不大，就再重新随机选一个；如果两者相差比较明显，那么就随机选取一个位置，将两者都分割为头部和尾部。最后，将当前文件的头部与随机文件的尾部拼接起来，就得到了新的文件。在这里，AFL还会过滤掉拼接文件未发生变化的情况。</p>
<hr>
<p>###（7）cycle</p>
<p>于是乎，一个seed文件，在上述的全部变异都执行完成后，就…抱歉，还没结束。</p>
<p>上面的变异完成后，AFL会对文件队列的下一个进行变异处理。当队列中的全部文件都变异测试后，就完成了一个”cycle”，这个就是AFL状态栏右上角的”cycles done”。而正如cycle的意思所说，整个队列又会从第一个文件开始，再次进行变异，不过与第一次变异不同的是，这一次就不需要再进行deterministic fuzzing了。</p>
<p>当然，如果用户不停止AFL，那么seed文件将会一遍遍的变异下去。</p>
<p>变异的具体源代码可自行查看afl项目文件 <code>afl-fuzz.c</code> 中的 <code>fuzz_one()</code> 函数。</p>
<h3 id="效果分析">效果分析</h3>
<p>参考 <code>https://lcamtuf.blogspot.com/2014/11/pulling-jpegs-out-of-thin-air.html</code> 中的测试方法，同样以 <code>djpeg</code> 为目标，最初的样本集只有一个文本 <code>test</code>，采用二进制插桩的方式进行fuzz，1个主节点以及3个从节点同时进行，测试最终是否能fuzz出一个合法的图片文件。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094925.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094925.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094925.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094925.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094925.png"
        title="image-20210825094925024" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094908.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094908.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094908.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094908.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094908.png"
        title="image-20210825094908754" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094941.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094941.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094941.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094941.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094941.png"
        title="image-20210825094941149" /></p>
<p>fuzz后的样本集合如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094955.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094955.png, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094955.png 1.5x, https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094955.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AlexsanderShaw/BlogImages@main/img/vuln/shebei20210825094955.png"
        title="image-20210825094955862" /></p>
<p>使用 <code>afl-showmap</code> 对所有样本进行分析，编写脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nv">path</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">dpath</span><span class="o">=</span><span class="nv">$2</span>
rm -rf <span class="nv">$2</span>/*
<span class="k">for</span> file in <span class="k">$(</span>ls <span class="nv">$1</span><span class="k">)</span>
<span class="k">do</span>
    <span class="nb">echo</span> -e <span class="s1">&#39;\n&#39;</span><span class="nv">$file</span>
    afl-showmap -o <span class="nv">$2</span>/<span class="nv">$file</span> -Q -- /usr/bin/djpeg <span class="nv">$1</span>/<span class="nv">$file</span>
    <span class="nb">echo</span> -e <span class="s1">&#39;-------------------------------------\n&#39;</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>第一个参数为样本集合目录，第二个参数为输出目录，假设脚本名为 <code>djpeg.sh</code> ，样本目录为 <code>in</code> ，输出目录为 <code>map</code></p>
<pre><code>./djpeg.sh in map
</code></pre>
<p>脚本的执行结果可在 <code>分析/djpeg_sh脚本输出结果.txt</code> 中查看，以下只展示部分：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">id:000000,orig:1
afl-showmap 2.56b by &lt;lcamtuf@google.com&gt;
<span class="o">[</span>*<span class="o">]</span> Executing <span class="s1">&#39;/usr/bin/djpeg&#39;</span>...

-- Program output begins --
Not a JPEG file: starts with 0x74 0x65
-- Program output ends --
<span class="o">[</span>+<span class="o">]</span> Captured <span class="m">50</span> tuples in <span class="s1">&#39;map/id:000000,orig:1&#39;</span>.
-------------------------------------
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">id:000001,src:000000,op:havoc,rep:64,+cov
afl-showmap 2.56b by &lt;lcamtuf@google.com&gt;
<span class="o">[</span>*<span class="o">]</span> Executing <span class="s1">&#39;/usr/bin/djpeg&#39;</span>...
		
-- Program output begins --
Corrupt JPEG data: <span class="m">2</span> extraneous bytes before marker 0xfe
JPEG datastream contains no image
-- Program output ends --
<span class="o">[</span>+<span class="o">]</span> Captured <span class="m">68</span> tuples in <span class="s1">&#39;map/id:000001,src:000000,op:havoc,rep:64,+cov&#39;</span>.
-------------------------------------
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">id:000005,src:000000+000001,op:splice,rep:64
afl-showmap 2.56b by &lt;lcamtuf@google.com&gt;
<span class="o">[</span>*<span class="o">]</span> Executing <span class="s1">&#39;/usr/bin/djpeg&#39;</span>...

-- Program output begins --
Corrupt JPEG data: <span class="m">6</span> extraneous bytes before marker 0xfe
JPEG datastream contains no image
-- Program output ends --
<span class="o">[</span>+<span class="o">]</span> Captured <span class="m">68</span> tuples in <span class="s1">&#39;map/id:000005,src:000000+000001,op:splice,rep:64&#39;</span>.
-------------------------------------
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">id:000021,src:000011,op:flip32,pos:2,+cov
afl-showmap 2.56b by &lt;lcamtuf@google.com&gt;
<span class="o">[</span>*<span class="o">]</span> Executing <span class="s1">&#39;/usr/bin/djpeg&#39;</span>...

-- Program output begins --
Premature end of JPEG file
JPEG datastream contains no image
-- Program output ends --
<span class="o">[</span>+<span class="o">]</span> Captured <span class="m">59</span> tuples in <span class="s1">&#39;map/id:000021,src:000011,op:flip32,pos:2,+cov&#39;</span>.
-------------------------------------
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">id:000026,src:000021,op:havoc,rep:2
afl-showmap 2.56b by &lt;lcamtuf@google.com&gt;
<span class="o">[</span>*<span class="o">]</span> Executing <span class="s1">&#39;/usr/bin/djpeg&#39;</span>...

-- Program output begins --
Premature end of JPEG file
JPEG datastream contains no image
-- Program output ends --
<span class="o">[</span>+<span class="o">]</span> Captured <span class="m">60</span> tuples in <span class="s1">&#39;map/id:000026,src:000021,op:havoc,rep:2&#39;</span>.
-------------------------------------
</code></pre></td></tr></table>
</div>
</div><p>可以看到上面样本id为21和26的输出结果相同，但是执行路径不同，可以使用 <code>diff</code> 指令进行路径对比：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">diff -Nu map/id<span class="se">\:</span>000021<span class="se">\,</span>src<span class="se">\:</span>000011<span class="se">\,</span>op<span class="se">\:</span>flip32<span class="se">\,</span>pos<span class="se">\:</span>2<span class="se">\,</span>+cov map/id<span class="se">\:</span>000026<span class="se">\,</span>src<span class="se">\:</span>000021<span class="se">\,</span>op<span class="se">\:</span>havoc<span class="se">\,</span>rep<span class="se">\:</span><span class="m">2</span>
</code></pre></td></tr></table>
</div>
</div><p>结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">--- map/id:000021,src:000011,op:flip32,pos:2,+cov       2019-12-03 06:38:42.236000000 +0000
+++ map/id:000026,src:000021,op:havoc,rep:2     2019-12-03 06:38:42.388000000 +0000
@@ -1,20 +1,21 @@
    003224:1
    004793:1
    005209:1
-005993:1
+005993:2
    006601:1
    007073:1
    008498:1
    008874:1
-010130:1
+010130:2
    010146:1
    010282:1
-013459:1
+013459:2
+014971:1
    017564:1
    018892:1
    019132:1
    019148:1
-019172:1
+019172:2
    019188:1
    019236:1
    019804:1
@@ -33,18 +34,18 @@
    032872:1
    033112:1
    037297:1
-037433:1
+037433:2
    037817:1
    039585:1
-039641:2
-043450:1
+039641:4
+043450:2
    043562:1
    044194:1
    044818:1
    045483:1
    046955:1
    047603:1
-048251:1
+048251:2
    051300:1
    052444:1
    053124:1
</code></pre></td></tr></table>
</div>
</div><p>从最初的只有文本内容“test”的样本，afl确实已经发现了很多其它路径，但是在我的测试结果中还是没有fuzz出正常的图片文件，从输出结果上看样本id为21和26算是比较接近，没有报明显错误。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">Premature end of JPEG file
JPEG datastream contains no image
</code></pre></td></tr></table>
</div>
</div><h3 id="参考链接">参考链接</h3>
<ol>
<li><a href="https://github.com/google/AFL" target="_blank" rel="noopener noreffer">https://github.com/google/AFL</a></li>
<li><a href="https://www.secpulse.com/archives/71903.html" target="_blank" rel="noopener noreffer">https://www.secpulse.com/archives/71903.html</a></li>
<li><a href="https://www.freebuf.com/articles/system/191536.html" target="_blank" rel="noopener noreffer">https://www.freebuf.com/articles/system/191536.html</a></li>
<li><a href="http://zeroyu.xyz/2019/05/15/how-to-use-afl-fuzz" target="_blank" rel="noopener noreffer">http://zeroyu.xyz/2019/05/15/how-to-use-afl-fuzz</a></li>
<li><a href="https://lcamtuf.blogspot.com/2014/11/pulling-jpegs-out-of-thin-air.html" target="_blank" rel="noopener noreffer">https://lcamtuf.blogspot.com/2014/11/pulling-jpegs-out-of-thin-air.html</a></li>
<li><a href="https://paper.seebug.org/841/" target="_blank" rel="noopener noreffer">https://paper.seebug.org/841/</a></li>
<li><a href="https://paper.seebug.org/496/#part-2afl" target="_blank" rel="noopener noreffer">https://paper.seebug.org/496/#part-2afl</a></li>
<li><a href="https://rk700.github.io/2017/12/28/afl-internals/" target="_blank" rel="noopener noreffer">https://rk700.github.io/2017/12/28/afl-internals/</a></li>
<li><a href="https://rk700.github.io/2018/01/04/afl-mutations/" target="_blank" rel="noopener noreffer">https://rk700.github.io/2018/01/04/afl-mutations/</a></li>
<li><a href="https://rk700.github.io/2018/02/02/afl-enhancement/" target="_blank" rel="noopener noreffer">https://rk700.github.io/2018/02/02/afl-enhancement/</a></li>
</ol></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-01-05</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" data-title="AFL二三事 -- 2" data-via="@YaoyaoShaw" data-hashtags="Fuzz,AFL"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" data-hashtag="Fuzz"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" data-title="AFL二三事 -- 2"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" data-title="AFL二三事 -- 2"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B3/" data-title="AFL二三事 -- 2" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/fuzz/">Fuzz</a>,&nbsp;<a href="/tags/afl/">AFL</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/WindowsDev/WindowsKernel/" class="prev" rel="prev" title="Windows内核函数前缀简述"><i class="fas fa-angle-left fa-fw"></i>Windows内核函数前缀简述</a>
            <a href="/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B2/" class="next" rel="next" title="AFL二三事 -- 2">AFL二三事 -- 2<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Something just like this.</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://www.v4ler1an.com" target="_blank">v4ler1an-有毒</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"valine":{"appId":"OGG2bwJUUrIOs4sAfU87yE6d-gzGzoHsz","appKey":"vOzsADf7YdkMoNXlgShAFepl","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"人世纷乱，出入平安。","recordIP":true,"visitor":true}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
